# Relayer

- [Relayer](#relayer)
  - [Changes for ICQ](#changes-for-icq)
  - [Relayer Subsidisation](#relayer-subsidisation)

## Changes for ICQ

This section describes the changes that were applied to the [Cosmos relayer](https://github.com/cosmos/relayer) in order for it to be able to fulfil interchain queries generated by the [ICQ module](Icq.md). The relayer is expected to parse queries from the requesting chain (src), perform them on the chain (dst) indicated in the query, and pass the result back to the requesting chain (src).

For a particular _src_/_dst_ chain pair, the `relayerMainLoop` in `relayer/strategies.go` performs a call to `relayInterchainqueryPackets` in every loop, if the `interchainquery` boolean is True. This function fetches unrelayed interchain queries and relays them. This process is described in more detail below. There is also an interchainquery `buffer` which allows the relayer to ignore requests which will expire in X amount of blocks as the relayer will not manage to make a valid transaction in time.

**Fetching of unrelayed queries involves**:

1. Fetching all pending interchainquery instances from _src_ chain.
2. Filtering those out that will expire before buffer period.

**Relaying of unrelayed interchain queries, if any, involves**:

1. Performing the actual query against the _dst_ chain using `QueryStateABCI` from the `CosmosProvider`.
2. Constructing a `MsgSubmitICQResult` with the query result and proof.

The list of messages are collected into a `*[]provider.RelayerMessage` array and broadcast to the _src_ chain using a standard `Send` function.

## Relayer Subsidisation

Relayers spend tokens in order to operate. We need to make sure that they can do this sustainably. An example of relayer subsidisation (on Juno) is: https://daodao.zone/multisig/juno19nccy4t3wf27pu7pa68u2amkf9ecwk7w9600cqrqrfp0y24fzp4sf8eza3/proposals/2

Currently the ICQ module doesn't offer automatic relay subsidization but will in the future.
